<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🌌/☀️ XRP 投げ銭アプリ</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for theming */
    :root {
      /* Night Mode Defaults */
      --bg-color: #1a1a2e; /* Dark Blue */
      --container-bg: #16213e; /* Slightly lighter dark blue */
      --text-color: #e0e0e0; /* Light Gray */
      --accent-color-1: #0f3460; /* Darker accent */
      --accent-color-2: #e94560; /* Reddish pink (for highlights/errors) */
      --primary-button-bg: #4a90e2; /* Blue */
      --primary-button-hover: #357bd8; /* Darker Blue */
      --success-color: #5cb85c; /* Green */
      --info-color: #3f72af; /* Muted blue */
      --border-color: #0c183d; /* Very dark border */
      --input-bg: #283a5e; /* Darker blue for input */
      --qr-border: #8d9bb5; /* Light muted blue */
      --hr-color: #0c183d;
      --note-bg: #3c4c70; /* Memo background */
      --note-border: #5a6b90; /* Memo border */
      --note-text: #ffffff; /* Memo text color */
      --pin-input-bg: #22304f;
      --pin-input-border: #405a80;
      --note-line-color: #5c6e91; /* Memo line color */
      --copy-icon-color: #bbbbbb; /* Copy icon color */
      --watch-button-bg: #3f72af; /* Button for watch transfer */
      --watch-button-hover: #346296; /* Hover for watch button */


      /* Day Mode Overrides (initially hidden) */
      --day-bg-color: #f0f2f5;
      --day-container-bg: #ffffff;
      --day-text-color: #333333;
      --day-accent-color-1: #e0f7fa;
      --day-accent-color-2: #ff7043; /* Orange for highlights/errors */
      --day-primary-button-bg: #2196f3; /* Brighter Blue */
      --day-primary-button-hover: #1976d2;
      --day-success-color: #4caf50;
      --day-info-color: #03a9f4;
      --day-border-color: #e0e0e0;
      --day-input-bg: #f9f9f9;
      --day-qr-border: #9e9e9e;
      --day-hr-color: #e0e0e0;
      --day-note-bg: #ffffff; /* Day memo background */
      --day-note-border: #d0d0d0; /* Day memo border */
      --day-note-text: #333333; /* Day memo text */
      --day-pin-input-bg: #f5f5f5;
      --day-pin-input-border: #cccccc;
      --day-note-line-color: #e0e0e0; /* Day memo line color */
      --day-copy-icon-color: #666666; /* Copy icon color */
      --day-watch-button-bg: #03a9f4;
      --day-watch-button-hover: #0288d1;
    }

    body.day-mode {
      --bg-color: var(--day-bg-color);
      --container-bg: var(--day-container-bg);
      --text-color: var(--day-text-color);
      --accent-color-1: var(--day-accent-color-1);
      --accent-color-2: var(--day-accent-color-2);
      --primary-button-bg: var(--day-primary-button-bg);
      --primary-button-hover: var(--day-primary-button-hover);
      --success-color: var(--day-success-color);
      --info-color: var(--day-info-color);
      --border-color: var(--day-border-color);
      --input-bg: var(--day-input-bg);
      --qr-border: var(--day-qr-border);
      --hr-color: var(--day-hr-color);
      --note-bg: var(--day-note-bg);
      --note-border: var(--day-note-border);
      --note-text: var(--day-note-text);
      --pin-input-bg: var(--day-pin-input-bg);
      --pin-input-border: var(--day-pin-input-border);
      --note-line-color: var(--day-note-line-color);
      --copy-icon-color: var(--day-copy-icon-color);
      --watch-button-bg: var(--day-watch-button-bg);
      --watch-button-hover: var(--day-watch-button-hover);
    }

    body {
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      padding: 15px; /* 全体的なパディングをさらに詰める */
      background-color: var(--bg-color);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      color: var(--text-color);
      position: relative;
      transition: background-color 0.5s ease;
      overflow-y: auto;
      line-height: 1.35; /* 全体の行間をさらに詰める */
    }

    body:not(.day-mode)::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #0c183d, #1a1a2e, #0c183d);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      z-index: -1;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      background-color: var(--container-bg);
      padding: 20px; /* 全体的にパディングをさらに減らす */
      border-radius: 12px; /* 角丸を少し小さく */
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* シャドウを調整 */
      text-align: center;
      max-width: 500px; /* 最大幅を少し小さく */
      width: 100%;
      border: 1px solid var(--border-color); /* 枠線を細く */
      position: relative;
      animation: fadeIn 0.8s ease-out; /* アニメーション時間を短縮 */
      transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
      margin: auto;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-15px); } /* 少しだけ移動距離を減らす */
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      color: var(--primary-button-bg);
      margin-bottom: 18px; /* マージンをさらに減らす */
      font-size: 2em; /* 文字をさらに小さく */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px; /* ギャップをさらに減らす */
      text-shadow: 0 0 8px rgba(74, 144, 226, 0.5); /* Glowing effect */
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }
    body.day-mode h1 {
      text-shadow: none;
    }

    h2 {
      color: var(--text-color);
      margin-top: 20px; /* マージンをさらに減らす */
      margin-bottom: 12px; /* マージンをさらに減らす */
      font-size: 1.5em; /* 文字をさらに小さく */
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }
    body.day-mode h2 {
      text-shadow: none;
    }

    p {
      color: var(--text-color);
      line-height: 1.4; /* 行間をさらに詰める */
      font-size: 0.9em; /* 文字をさらに小さく */
      margin-bottom: 8px; /* マージンを詰める */
      transition: color 0.5s ease;
    }

    .streamer-info p {
      margin-bottom: 12px;
    }

    .xrpl-address-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 12px; /* マージンを詰める */
    }

    .xrpl-address {
      font-family: 'Share Tech Mono', monospace;
      background-color: var(--input-bg);
      padding: 9px 10px; /* パディングをさらに減らす */
      border-radius: 6px; /* 角丸を小さく */
      font-size: 0.85em; /* 文字をさらに小さく */
      color: var(--text-color);
      word-break: break-all;
      border: 1px solid var(--border-color);
      width: 100%;
      flex-grow: 1;
      transition: all 0.3s ease;
    }

    .xrpl-address:focus {
      outline: none;
      border-color: var(--primary-button-bg);
      box-shadow: 0 0 6px rgba(74, 144, 226, 0.6);
    }
    body.day-mode .xrpl-address:focus {
      box-shadow: 0 0 6px rgba(33, 150, 243, 0.6);
    }

    .copy-icon-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 3px; /* アイコンのクリック範囲を調整 */
      color: var(--copy-icon-color);
      font-size: 1.1em; /* アイコンサイズを調整 */
      transition: color 0.3s ease, transform 0.2s ease;
      position: absolute;
      right: 8px; /* 位置調整 */
      top: 50%;
      transform: translateY(-50%);
    }

    .copy-icon-button:hover {
      color: var(--primary-button-bg);
      transform: translateY(-50%) scale(1.1);
    }
    .copy-icon-button:active {
      transform: translateY(-50%) scale(0.9);
    }

    .address-buttons {
      display: flex;
      gap: 8px; /* ボタン間のスペースを詰める */
      justify-content: center;
      margin-bottom: 8px; /* 下のマージンを詰める */
    }

    .connect-button {
      background-color: var(--primary-button-bg);
      color: white;
      border: none;
      padding: 7px 12px; /* パディングをさらに減らす */
      border-radius: 6px; /* 角丸を小さく */
      cursor: pointer;
      font-size: 0.85em; /* 文字をさらに小さく */
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3); /* シャドウを調整 */
      flex-grow: 1;
    }

    .connect-button:hover {
      background-color: var(--primary-button-hover);
      transform: translateY(-1px); /* 少しだけ移動 */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .copy-status {
      color: var(--success-color);
      font-weight: bold;
      margin-top: 8px; /* マージンを減らす */
      font-size: 0.8em; /* 文字をさらに小さく */
      opacity: 0;
      transition: opacity 0.4s ease-out; /* フェードアウトアニメーションを短縮 */
    }
    .copy-status.show {
      opacity: 1;
    }

    .input-group {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px; /* マージンを減らす */
      gap: 8px; /* ギャップを減らす */
    }

    .input-group input[type="number"] {
      padding: 9px 10px; /* パディングをさらに減らす */
      border: 1px solid var(--border-color);
      border-radius: 6px; /* 角丸を小さく */
      font-size: 1em; /* 文字をさらに小さく */
      width: 100px; /* 幅を調整 */
      text-align: right;
      background-color: var(--input-bg);
      color: var(--text-color);
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.3s ease;
    }

    .input-group input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-button-bg);
      box-shadow: 0 0 6px rgba(74, 144, 226, 0.6);
    }
    body.day-mode .input-group input[type="number"]:focus {
      box-shadow: 0 0 6px rgba(33, 150, 243, 0.6);
    }

    .input-group span {
      font-size: 1em; /* 文字をさらに小さく */
      font-weight: bold;
      color: var(--primary-button-bg);
      text-shadow: 0 0 4px rgba(74, 144, 226, 0.3);
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }
    body.day-mode .input-group span {
      text-shadow: none;
    }

    .tip-button {
      background-color: var(--accent-color-2);
      color: white;
      border: none;
      padding: 10px 20px; /* パディングをさらに減らす */
      border-radius: 8px; /* 角丸を少し小さく */
      font-size: 1.1em; /* 文字をさらに小さく */
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4); /* シャドウを調整 */
      letter-spacing: 0.2px; /* 文字間隔をさらに詰める */
    }

    .tip-button:hover {
      background-color: #d63d58;
      transform: translateY(-2px) scale(1.01); /* 少しだけ移動と拡大 */
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
    }
    body.day-mode .tip-button:hover {
      background-color: #f5511e;
    }

    .tip-button:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .message {
      margin-top: 15px; /* マージンを減らす */
      padding: 8px 12px; /* パディングをさらに減らす */
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9em; /* 文字をさらに小さく */
      transition: all 0.4s ease; /* アニメーション時間を短縮 */
    }

    .message.info {
      background-color: rgba(63, 114, 175, 0.2);
      color: var(--info-color);
      border: 1px solid var(--info-color);
    }
    body.day-mode .message.info {
      background-color: rgba(3, 169, 244, 0.1);
    }

    .message.success {
      background-color: rgba(92, 184, 92, 0.2);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }
    body.day-mode .message.success {
      background-color: rgba(76, 175, 80, 0.1);
    }

    .qr-code-area {
      margin-top: 20px; /* マージンを減らす */
      padding: 15px; /* パディングを減らす */
      background-color: var(--accent-color-1);
      border-radius: 10px; /* 角丸を小さく */
      border: 2px dashed var(--qr-border);
      display: none;
      opacity: 0;
      transform: scale(0.95); /* 少しだけ縮小 */
      transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.5s ease, border-color 0.5s ease; /* アニメーション時間を短縮 */
    }

    .qr-code-area.show {
      opacity: 1;
      transform: scale(1);
    }

    .qr-image {
      width: 160px; /* QRコードをさらに小さく */
      height: 160px;
      margin: 15px auto;
      display: block;
      border: 5px solid white; /* 枠線を細く */
      border-radius: 4px; /* 角丸を小さく */
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); /* シャドウを調整 */
      transition: border-color 0.5s ease, box-shadow 0.5s ease;
    }
    
    .qr-code-area p {
      font-size: 0.8em; /* 文字をさらに小さく */
      line-height: 1.25;
      margin-bottom: 6px; /* マージンを詰める */
    }

    .qr-code-area p:last-of-type {
        margin-top: 12px; /* マージンを詰める */
    }

    .qr-buttons-group {
        display: flex;
        flex-wrap: wrap; /* ボタンを折り返す */
        justify-content: center;
        gap: 8px; /* ボタン間のスペース */
        margin-top: 10px;
    }

    .action-button { /* General style for action buttons in QR area */
      color: white;
      border: none;
      padding: 9px 18px; /* パディングをさらに減らす */
      border-radius: 6px; /* 角丸を小さく */
      font-size: 0.9em; /* 文字をさらに小さく */
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      flex-grow: 1; /* ボタンを横に広げる */
      min-width: 120px; /* 最小幅を設定 */
    }

    .open-xaman-button {
      background-color: var(--success-color);
    }
    .open-xaman-button:hover {
      background-color: #4CAF50;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    body.day-mode .open-xaman-button {
      background-color: var(--day-success-color);
    }
    body.day-mode .open-xaman-button:hover {
      background-color: #388e3c;
    }

    .send-to-watch-button {
        background-color: var(--watch-button-bg); /* 新しいボタンの色 */
    }
    .send-to-watch-button:hover {
        background-color: var(--watch-button-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    body.day-mode .send-to-watch-button {
        background-color: var(--day-watch-button-bg);
    }
    body.day-mode .send-to-watch-button:hover {
        background-color: var(--day-watch-button-hover);
    }

    .watch-transfer-section {
        background-color: var(--accent-color-1); /* QRコードエリアと同じ背景色 */
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
        display: none; /* Initially hidden */
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.5s ease;
        border: 1px dashed var(--qr-border);
    }
    .watch-transfer-section.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
    .watch-transfer-section p {
        margin-bottom: 10px;
        font-size: 0.85em;
        text-align: left;
    }
    .watch-transfer-section ul {
        list-style: none; /* ドットを消す */
        padding-left: 0;
        margin-bottom: 10px;
        font-size: 0.8em;
        text-align: left;
        line-height: 1.4;
    }
    .watch-transfer-section li {
        margin-bottom: 5px;
    }
    .watch-transfer-section strong {
        color: var(--primary-button-bg);
    }


    hr {
      border: none;
      border-top: 1px dashed var(--hr-color);
      margin: 25px 0; /* マージンを減らす */
      transition: border-color 0.5s ease;
    }

    .container button:not(.tip-button):hover,
    .container input:not([type="number"]):hover {
      box-shadow: 0 0 12px rgba(74, 144, 226, 0.8); /* シャドウを調整 */
    }
    body.day-mode .container button:not(.tip-button):hover,
    body.day-mode .container input:not([type="number"]):hover {
      box-shadow: 0 0 12px rgba(33, 150, 243, 0.8);
    }

    /* Theme Toggle Switch */
    .theme-switch-wrapper {
      margin-bottom: 12px; /* マージンを減らす */
      gap: 6px; /* ギャップを減らす */
    }
    .theme-switch-wrapper span {
      font-size: 0.8em; /* 文字をさらに小さく */
    }
    .theme-switch {
      height: 22px; /* 高さを小さく */
      width: 40px; /* 幅を小さく */
    }
    .slider:before {
      bottom: 2px; /* 位置調整 */
      height: 18px; /* サイズを小さく */
      left: 2px; /* 位置調整 */
      width: 18px; /* サイズを小さく */
    }
    input:checked + .slider:before {
      transform: translateX(18px); /* スライド距離調整 */
    }

    /* PIN and Memo Section */
    .memo-section {
      margin-top: 20px; /* マージンを減らす */
      padding: 15px; /* パディングを減らす */
      border-radius: 10px; /* 角丸を小さく */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* シャドウを調整 */
    }
    .memo-section.show {
      transform: translateY(0);
    }

    .memo-section h3 {
      font-size: 1.2em; /* 文字をさらに小さく */
      margin-bottom: 12px; /* マージンを減らす */
    }

    .pin-input-group {
      margin-bottom: 12px; /* マージンを減らす */
    }
    .pin-input-group input {
      width: 100px; /* 幅をさらに小さく */
      padding: 7px 10px; /* パディングをさらに減らす */
      font-size: 0.9em; /* 文字をさらに小さく */
      border-radius: 6px;
    }

    .pin-button {
      padding: 7px 18px; /* パディングをさらに減らす */
      border-radius: 6px;
      font-size: 0.85em; /* 文字をさらに小さく */
      margin-top: 8px; /* マージンを減らす */
    }
    .pin-status {
      font-size: 0.75em; /* 文字をさらに小さく */
      margin-top: 6px; /* マージンを減らす */
    }

    /* Memo input styling */
    .memo-input-container {
      margin-top: 15px; /* マージンを減らす */
      border-radius: 8px; /* 角丸を小さく */
      padding: 8px; /* パディングを減らす */
    }

    .memo-input {
      min-height: 100px; /* min-heightをさらに調整 */
      padding: 4px; /* パディングをさらに調整 */
      font-size: 0.9em; /* 文字をさらに小さく */
      line-height: 1.6em; /* 行間をさらに詰める */
      background-image:
          repeating-linear-gradient(
              to bottom,
              transparent,
              transparent 1.5em, /* Line height - 0.1em margin */
              var(--note-line-color) 1.6em /* Line color */
          );
      background-size: 100% 1.6em; /* background-sizeも行間に合わせる */
    }
    body.day-mode .memo-input {
      background-image:
          repeating-linear-gradient(
              to bottom,
              transparent,
              transparent 1.5em,
              var(--day-note-line-color) 1.6em
          );
    }

    /* Animations for emojis */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); } /* 少し控えめなアニメーション */
      100% { transform: scale(1); }
    }
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="night-mode">
  <div class="container">
    <div class="theme-switch-wrapper">
      <span>☀️ Day Mode</span>
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" onchange="toggleTheme()" checked />
        <div class="slider round"></div>
      </label>
      <span>🌌 Night Mode</span>
    </div>

    <h1><span style="font-size: 1.4em; animation: pulse 2s infinite;">💸</span> XRPを受け取る</h1>

    <div class="streamer-info">
      <p>あなたのXRPLテストネットアドレスを入力するか、ウォレットを接続してください：</p>
      <div class="xrpl-address-wrapper">
        <input type="text" id="streamerAddressInput" class="xrpl-address" placeholder="例: r...abc123" />
        <button onclick="copyAddress()" class="copy-icon-button" aria-label="アドレスをコピー">📋</button>
      </div>
      <div class="address-buttons">
        <button onclick="connectWallet()" class="connect-button">ウォレットに接続 <span style="margin-left: 5px;">🚀</span></button>
      </div>
      <p id="copyStatus" class="copy-status">✨ アドレスをコピーしました！</p>
    </div>

    <hr>

    <div class="viewer-section">
      <h2><span style="font-size: 1.1em; animation: rotate 3s infinite linear;">💰</span> XRPを投げ銭してもらう</h2>
      <p>（このデモでは0.1XRP固定です）</p>
      <div class="input-group">
        <input type="number" id="tipAmount" value="0.1" disabled> <span>XRP</span>
      </div>
      <button onclick="sendTip()" id="tipButton" class="tip-button">XRPを投げ銭してもらう <span style="margin-left: 8px;">✨</span></button>
      <p id="message" class="message"></p>
      <div id="qrCodeArea" class="qr-code-area">
        <p>他のデバイスでスキャンする場合: <br>XamanアプリでQRコードをスキャンしてください。</p>
        <img id="qrImage" class="qr-image" alt="QR Code">
        
        <p>**同じ携帯で送金する場合:**</p>
        <div class="qr-buttons-group">
            <button id="openXamanButton" class="action-button open-xaman-button">Xamanアプリで開く <span style="margin-left: 5px;">📱</span></button>
            <button id="sendToWatchButton" class="action-button send-to-watch-button" onclick="sendQrToWatch()">Apple Watchに送る ⌚️</button>
        </div>

        <div id="watchTransferSection" class="watch-transfer-section">
            <p><strong>Apple WatchにQRコードを表示する方法:</strong></p>
            <ul>
                <li><strong>AirDrop (推奨):</strong> 「Apple Watchに送る」ボタンをタップ後、AirDropの共有メニューが表示されたら、お使いのApple Watchを選択してください。</li>
                <li><strong>写真アプリ経由:</strong> AirDropがうまくいかない場合、QRコード画像は「写真」アプリに保存されます。Apple Watchで写真アプリを開き、保存されたQRコードを表示してスキャンしてください。</li>
            </ul>
        </div>
      </div>
    </div>

    <hr>

    <div id="memoSection" class="memo-section">
        <h3><span style="font-size: 1.1em;">📝</span> メモ機能</h3>
        
        <div id="memoInputControls" class="memo-input-controls">
          <p id="pinInstruction"></p>
          <div class="pin-input-group">
              <input type="password" id="pinInput" placeholder="PINコード (4桁)" maxlength="4" onkeyup="checkPinInput()">
          </div>
          <p id="pinStatus" class="pin-status"></p>
          <button onclick="verifyPin()" id="verifyPinButton" class="pin-button" disabled>PINを認証</button>
        </div>

        <div id="memoInputContainer" class="memo-input-container">
            <textarea id="privateMemo" class="memo-input" placeholder="メモを入力..."></textarea>
        </div>
    </div>

  </div>

  <script>
    // ... 既存のJavaScriptコード ...

    let currentXummPayloadUrl = ''; // XUMMペイロードのQRコードURLを格納

    async function sendTip() {
        const tipButton = document.getElementById('tipButton');
        const messageElement = document.getElementById('message');
        const qrCodeArea = document.getElementById('qrCodeArea');
        const qrImage = document.getElementById('qrImage');
        const watchTransferSection = document.getElementById('watchTransferSection');
        const address = document.getElementById('streamerAddressInput').value.trim();
        const tipAmount = document.getElementById('tipAmount').value; // 金額もバックエンドに渡す

        if (!isValidXrplAddress(address)) {
            if (address === '') {
                connectWallet();
                return;
            }
            alert('正しいXRPLアドレスを入力してください。');
            return;
        }

        tipButton.disabled = true;
        messageElement.textContent = '🌌 XUMM支払いリクエストを生成中です...';
        messageElement.className = 'message info';
        qrCodeArea.classList.remove('show');
        watchTransferSection.classList.remove('show');

        try {
            // バックエンドAPIを呼び出してXUMMペイロードを作成
            const response = await fetch('/api/create-xumm-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    destination: address,
                    amount: tipAmount,
                    // memo: document.getElementById('privateMemo').value, // メモも送りたい場合は追加
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'XUMM支払いリクエストの生成に失敗しました。');
            }

            const data = await response.json();
            currentXummPayloadUrl = data.qrCodeUrl; // XUMMから返されたQRコードURL
            currentXrpUri = data.xummDeepLink; // XUMMディープリンクも取得 (Xamanアプリで開くに利用)

            if (currentXummPayloadUrl) {
                qrImage.src = currentXummPayloadUrl;

                qrImage.onload = () => {
                    qrCodeArea.style.display = 'block';
                    setTimeout(() => {
                        qrCodeArea.classList.add('show');
                    }, 50);
                    messageElement.textContent = '✅ 投げ銭準備が完了しました！XamanアプリでQRコードをスキャンするか、直接開いてください。';
                    messageElement.className = 'message success';
                    tipButton.disabled = false;
                };
                qrImage.onerror = () => {
                    messageElement.textContent = '❌ QRコードの読み込みに失敗しました。';
                    messageElement.className = 'message error';
                    tipButton.disabled = false;
                };
            } else {
                throw new Error('QRコードURLが取得できませんでした。');
            }

        } catch (error) {
            console.error('支払いリクエストエラー:', error);
            messageElement.textContent = `❌ エラー: ${error.message}`;
            messageElement.className = 'message error';
            tipButton.disabled = false;
        }
    }

    // openXamanDeepLink関数も currentXrpUri を使うように調整
    function openXamanDeepLink(uri) {
        // ... (この関数は大きく変更する必要はありませんが、currentXrpUri が xumm:// の形式になることを想定します) ...
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS || isAndroid) {
            // XUMM APIから返されるURIは既に xumm:// または https://xumm.app/ の形式なので、xrp.to の変換は不要になる可能性が高いです
            // 必要に応じて `uri.replace('https://xumm.app/', 'xumm://')` のような変換を入れる
            window.location.href = uri; 

            const timeout = setTimeout(() => {
                if (isIOS) {
                    window.location.href = 'https://apps.apple.com/jp/app/xaman-wallet/id1492302343';
                } else if (isAndroid) {
                    window.location.href = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';
                }
            }, 1000);

            const handleVisibilityChangeForApp = () => {
                if (!document.hidden) {
                    clearTimeout(timeout);
                    document.removeEventListener('visibilitychange', handleVisibilityChangeForApp);
                }
            };
            document.addEventListener('visibilitychange', handleVisibilityChangeForApp);

        } else {
            window.open(uri, '_blank');
            alert('PCではXamanアプリは通常インストールされていません。Xummのページが開きますので、そちらで手続きを進めてください。');
        }
    }
    let currentXrpUri = ''; // Global variable to store the generated XRP URI
    let currentQrImageUrl = ''; // Global variable to store the generated QR code image URL
    const LOCAL_STORAGE_PIN_KEY = 'memoPinCode'; // PINを保存するキー
    const LOCAL_STORAGE_MEMO_UNLOCKED_KEY = 'memoUnlocked'; // メモがアンロックされた状態を保存するキー
    const LOCAL_STORAGE_MEMO_CONTENT_KEY = 'privateMemoContent'; // メモの内容を保存するキー

    let storedPin = null; // デバイスに保存されているPIN
    let inactivityTimer; // スリープモード（非アクティブ）を検出するタイマー
    const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5分 (ミリ秒)

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('streamerAddressInput').value = '';
      // Set initial theme based on local storage or default to night mode
      const savedTheme = localStorage.getItem('theme') || 'night-mode';
      document.body.className = savedTheme;
      document.getElementById('checkbox').checked = (savedTheme === 'night-mode');

      // メモ機能の初期状態を設定
      initializeMemoSection();
      
      // Load saved memo
      const savedMemo = localStorage.getItem(LOCAL_STORAGE_MEMO_CONTENT_KEY);
      if (savedMemo) {
          document.getElementById('privateMemo').value = savedMemo;
      }
      // Save memo on input change
      document.getElementById('privateMemo').addEventListener('input', (event) => {
          localStorage.setItem(LOCAL_STORAGE_MEMO_CONTENT_KEY, event.target.value);
      });

      // Event listener for the "Open in Xaman" button
      document.getElementById('openXamanButton').addEventListener('click', () => {
          if (currentXrpUri) {
              // モバイル環境でのディープリンク試行
              openXamanDeepLink(currentXrpUri);
          } else {
              alert('まず投げ銭ボタンを押して送金リンクを生成してください。');
          }
      });

      // スリープモード検出のためのイベントリスナーを設定
      document.addEventListener('visibilitychange', handleVisibilityChange);
      document.addEventListener('mousemove', resetInactivityTimer);
      document.addEventListener('keydown', resetInactivityTimer);
      document.addEventListener('click', resetInactivityTimer);
      document.addEventListener('scroll', resetInactivityTimer);
      document.addEventListener('touchstart', resetInactivityTimer);
      resetInactivityTimer(); // ページロード時にもタイマーをリセット
    });

    // スリープモード（非アクティブ）検出のための処理
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(lockMemoSection, INACTIVITY_TIMEOUT);
    }

    function handleVisibilityChange() {
        if (document.hidden) {
            // タブが非アクティブになった場合、すぐにロック
            lockMemoSection();
        } else {
            // タブがアクティブに戻った場合、タイマーをリセット
            resetInactivityTimer();
        }
    }

    function lockMemoSection() {
        // メモセクションがロックされていない場合のみロック処理を行う
        if (localStorage.getItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY) === 'true') {
            localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'false'); // ロック状態に設定
            document.getElementById('memoInputContainer').classList.remove('show'); // メモ入力欄を隠す
            document.getElementById('memoInputControls').classList.remove('hidden'); // PIN入力欄を表示
            document.getElementById('pinInput').value = ''; // PIN入力をクリア
            document.getElementById('pinInput').focus(); // PIN入力にフォーカス
            document.getElementById('pinInstruction').textContent = 'メモにアクセスするにはPINコードを再入力してください。';
            document.getElementById('pinStatus').textContent = '';
            document.getElementById('verifyPinButton').disabled = true;
            // アラートは初回のロック時のみ表示し、以降はコンソールログのみ
            console.log('Memo section locked due to inactivity or visibility change.');
        }
    }


    function toggleTheme() {
      const body = document.body;
      if (body.classList.contains('day-mode')) {
        body.classList.remove('day-mode');
        body.classList.add('night-mode');
        localStorage.setItem('theme', 'night-mode');
      } else {
        body.classList.remove('night-mode');
        body.classList.add('day-mode');
        localStorage.setItem('theme', 'day-mode');
      }
    }

    async function copyAddress() {
      try {
        const address = document.getElementById('streamerAddressInput').value;
        if (!address) {
          alert('アドレスが入力されていません。');
          return;
        }
        await navigator.clipboard.writeText(address);
        const copyStatus = document.getElementById('copyStatus');
        copyStatus.classList.add('show');
        setTimeout(() => {
          copyStatus.classList.remove('show');
        }, 1500); // 表示時間を少し短縮
      } catch (err) {
        console.error('コピー失敗:', err);
        alert('コピーに失敗しました。');
      }
    }

    function isValidXrplAddress(address) {
      return /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/.test(address);
    }

    async function sendTip() {
      const tipButton = document.getElementById('tipButton');
      const messageElement = document.getElementById('message');
      const qrCodeArea = document.getElementById('qrCodeArea');
      const qrImage = document.getElementById('qrImage');
      const watchTransferSection = document.getElementById('watchTransferSection');
      const address = document.getElementById('streamerAddressInput').value.trim();

      if (!isValidXrplAddress(address)) {
        // アドレスがない場合は自動的にXaman接続へ誘導
        if (address === '') {
            connectWallet(); // アドレスがない場合はXamanアプリに接続を試みる
            return;
        }
        alert('正しいXRPLアドレスを入力してください。');
        return;
      }

      currentXrpUri = `https://xrp.to/?to=${encodeURIComponent(address)}&amount=0.1`; // Store the URI
      currentQrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(currentXrpUri)}`; // QR画像のURLも保存

      tipButton.disabled = true;
      messageElement.textContent = '🌌 QRコードを生成中です...';
      messageElement.className = 'message info';
      qrCodeArea.classList.remove('show');
      watchTransferSection.classList.remove('show'); // Apple Watchセクションも隠す
      
      qrImage.src = currentQrImageUrl;
      
      // QRコードのロードが完了してから表示する
      qrImage.onload = () => {
        qrCodeArea.style.display = 'block';
        setTimeout(() => {
            qrCodeArea.classList.add('show');
        }, 50); 
        messageElement.textContent = '✅ 投げ銭準備が完了しました！QRコードをスキャンするか、Xamanアプリで開いてください。';
        messageElement.className = 'message success';
        tipButton.disabled = false;
      };
      // エラーハンドリング
      qrImage.onerror = () => {
        messageElement.textContent = '❌ QRコードの生成に失敗しました。時間をおいて再度お試しください。';
        messageElement.className = 'message error'; // エラー用のスタイルがあれば
        tipButton.disabled = false;
      };
    }

    // Xamanアプリへのディープリンクを試みる関数
    function openXamanDeepLink(uri) {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS || isAndroid) {
            // モバイル端末の場合、カスタムスキームでXamanアプリを直接開くことを試みる
            const customSchemeUri = uri.replace('https://xrp.to/', 'xaman://xrp.to/'); // xrp.toのURIをXamanスキームに変換

            window.location.href = customSchemeUri;

            // フォールバックとして、一定時間後にApp Store/Google Play Storeへリダイレクト
            // Xamanアプリがインストールされていない場合、このタイマーが発火する
            const timeout = setTimeout(() => {
                if (isIOS) {
                    window.location.href = 'https://apps.apple.com/jp/app/xaman-wallet/id1492302343';
                } else if (isAndroid) {
                    window.location.href = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';
                }
            }, 1000); // 1秒後にリダイレクトを試みる (短縮)

            // アプリが正常に開いた場合、タイマーをクリア
            // visibilitychangeイベントをトリガーするアプリ起動は、より確実な方法
            const handleVisibilityChangeForApp = () => {
                if (!document.hidden) { // ページが非表示から戻った場合
                    clearTimeout(timeout);
                    document.removeEventListener('visibilitychange', handleVisibilityChangeForApp);
                }
            };
            document.addEventListener('visibilitychange', handleVisibilityChangeForApp);

        } else {
            // PCの場合、xrp.toのウェブページを開く
            window.open(uri, '_blank');
            alert('PCではXamanアプリは通常インストールされていません。XRP.toのページが開きますので、そちらで手続きを進めてください。');
        }
    }


    // ウォレット接続機能（Xaman対応）
    async function connectWallet() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS || isAndroid) {
            // モバイル端末の場合の処理
            const xamanDeepLink = 'xaman://'; // Xamanアプリを開くディープリンク
            const appStoreLink = 'https://apps.apple.com/jp/app/xaman-wallet/id1492302343';
            const playStoreLink = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';

            window.location.href = xamanDeepLink;

            const timeout = setTimeout(() => {
                if (isIOS) {
                    window.location.href = appStoreLink;
                } else if (isAndroid) {
                    window.location.href = playStoreLink;
                }
            }, 1500);

            const handleVisibilityChangeForApp = () => {
                if (!document.hidden) {
                    clearTimeout(timeout);
                    document.removeEventListener('visibilitychange', handleVisibilityChangeForApp);
                }
            };
            document.addEventListener('visibilitychange', handleVisibilityChangeForApp);

            alert("Xamanアプリを起動しようとしています。もしアプリが起動しない場合は、数秒後にストアにリダイレクトされます。");

        } else {
            if (window.xrpl) { // XRPL.jsのようなブラウザ拡張機能の検出
                try {
                    const result = await window.xrpl.request({
                        command: "account_info",
                        account: null
                    });
                    const address = result.account_data?.Account;
                    if (address) {
                        document.getElementById("streamerAddressInput").value = address;
                        alert("ウォレットに接続しました！");
                    } else {
                        alert("アカウント情報の取得に失敗しました。");
                    }
                } catch (error) {
                    console.error("ウォレット接続エラー:", error);
                    alert("ウォレット接続に失敗しました。Xaman以外のXRPLブラウザ拡張機能が正しく動作しているか確認してください。");
                }
            } else {
                alert("Xamanは主にモバイルアプリです。PCブラウザで直接ウォレットに接続する拡張機能は見つかりませんでした。モバイルデバイスでこのページを開き、「ウォレットに接続」または「Xamanアプリで開く」ボタンをご利用いただくか、アドレスを手入力してください。");
            }
        }
    }

    // Apple WatchにQRコード画像を共有する機能
    async function sendQrToWatch() {
        if (!currentQrImageUrl) {
            alert('先に「XRPを投げ銭してもらう」ボタンでQRコードを生成してください。');
            return;
        }

        const watchTransferSection = document.getElementById('watchTransferSection');
        watchTransferSection.classList.add('show'); // 説明文を表示

        try {
            // QRコード画像をBlobとしてフェッチ
            const response = await fetch(currentQrImageUrl);
            const blob = await response.blob();
            const file = new File([blob], 'xrp_qr_code.png', { type: 'image/png' });

            // Web Share APIを使用して共有（AirDropなどを利用）
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'XRP QRコード',
                    text: 'XRP投げ銭用のQRコードです。Apple Watchに送信してください。'
                });
                console.log('QRコードが共有されました。');
            } else {
                alert('このブラウザまたはデバイスでは、QRコードを直接共有できません。QRコードを長押しして画像を保存し、写真アプリからApple Watchに転送してください。');
                console.warn('Web Share API (Files) is not supported or cannot share these files.');
                // 共有APIが利用できない場合のフォールバックとして、画像保存を促す
                // または、ここで画像をダウンロードさせる処理を追加することも検討できます。
            }
        } catch (error) {
            console.error('QRコードの共有に失敗しました:', error);
            alert('QRコードの共有に失敗しました。QRコード画像を長押しして保存し、写真アプリ経由でApple Watchに転送してください。');
        }
    }


    // --- PIN and Memo Functions ---

    function initializeMemoSection() {
        const memoUnlocked = localStorage.getItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY) === 'true';
        const pinInput = document.getElementById('pinInput');
        const pinInstruction = document.getElementById('pinInstruction');
        const memoInputContainer = document.getElementById('memoInputContainer');
        const memoInputControls = document.getElementById('memoInputControls');

        storedPin = localStorage.getItem(LOCAL_STORAGE_PIN_KEY);

        document.getElementById('memoSection').classList.add('show');

        if (memoUnlocked && storedPin) {
            pinInstruction.textContent = 'メモにアクセス済みです。';
            memoInputControls.classList.add('hidden');
            memoInputContainer.classList.add('show');
        } else if (storedPin) {
            pinInstruction.textContent = 'メモにアクセスするにはPINコードを再入力してください。';
            memoInputControls.classList.remove('hidden');
            memoInputContainer.classList.remove('show');
        } else {
            pinInstruction.textContent = 'メモにアクセスするためのPINコードを4桁で設定してください。';
            memoInputControls.classList.remove('hidden');
            memoInputContainer.classList.remove('show');
        }
        pinInput.value = '';
        checkPinInput();
    }

    function checkPinInput() {
        const pinInput = document.getElementById('pinInput');
        const verifyButton = document.getElementById('verifyPinButton');
        const pinStatus = document.getElementById('pinStatus');

        if (pinInput.value.length === 4) {
            verifyButton.disabled = false;
        } else {
            verifyButton.disabled = true;
        }

        if (pinInput.value.length > 0 && pinInput.value.length < 4) {
            pinStatus.textContent = 'PINコードは4桁です。';
            pinStatus.style.color = 'var(--text-color)';
        } else {
            pinStatus.textContent = '';
        }
    }

    function verifyPin() {
        const enteredPin = document.getElementById('pinInput').value;
        const pinStatus = document.getElementById('pinStatus');
        const memoInputContainer = document.getElementById('memoInputContainer');
        const pinInput = document.getElementById('pinInput');
        const verifyPinButton = document.getElementById('verifyPinButton');
        const memoInputControls = document.getElementById('memoInputControls');


        if (!storedPin) {
            localStorage.setItem(LOCAL_STORAGE_PIN_KEY, enteredPin);
            storedPin = enteredPin;
            localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'true');
            pinStatus.textContent = '新しいPINコードが設定されました！';
            pinStatus.style.color = 'var(--success-color)';
            
            memoInputControls.classList.add('hidden');
            memoInputContainer.classList.add('show');
            pinInput.value = '';
            document.getElementById('privateMemo').focus();
            resetInactivityTimer();
        } else {
            if (enteredPin === storedPin) {
                localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'true');
                pinStatus.textContent = 'PINコードが認証されました！';
                pinStatus.style.color = 'var(--success-color)';
                
                memoInputControls.classList.add('hidden');
                memoInputContainer.classList.add('show');
                pinInput.value = '';
                document.getElementById('privateMemo').focus();
                resetInactivityTimer();
            } else {
                localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'false');
                pinStatus.textContent = 'PINコードが正しくありません。もう一度お試しください。';
                pinStatus.style.color = 'var(--accent-color-2)';
                memoInputContainer.classList.remove('show');
                pinInput.value = '';
                verifyPinButton.disabled = true;
            }
        }
    }
  </script>
</body>
</html>
