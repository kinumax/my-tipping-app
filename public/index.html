<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸŒŒ/â˜€ï¸ XRP æŠ•ã’éŠ­ã‚¢ãƒ—ãƒª</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for theming */
    :root {
      /* Night Mode Defaults */
      --bg-color: #1a1a2e; /* Dark Blue */
      --container-bg: #16213e; /* Slightly lighter dark blue */
      --text-color: #e0e0e0; /* Light Gray */
      --accent-color-1: #0f3460; /* Darker accent */
      --accent-color-2: #e94560; /* Reddish pink (for highlights/errors) */
      --primary-button-bg: #4a90e2; /* Blue */
      --primary-button-hover: #357bd8; /* Darker Blue */
      --success-color: #5cb85c; /* Green */
      --info-color: #3f72af; /* Muted blue */
      --border-color: #0c183d; /* Very dark border */
      --input-bg: #283a5e; /* Darker blue for input */
      --qr-border: #8d9bb5; /* Light muted blue */
      --hr-color: #0c183d;
      --note-bg: #3c4c70; /* Memo background */
      --note-border: #5a6b90; /* Memo border */
      --note-text: #ffffff; /* Memo text color */
      --pin-input-bg: #22304f;
      --pin-input-border: #405a80;
      --note-line-color: #5c6e91; /* Memo line color */
      --copy-icon-color: #bbbbbb; /* Copy icon color */
      --watch-button-bg: #3f72af; /* Button for watch transfer */
      --watch-button-hover: #346296; /* Hover for watch button */


      /* Day Mode Overrides (initially hidden) */
      --day-bg-color: #f0f2f5;
      --day-container-bg: #ffffff;
      --day-text-color: #333333;
      --day-accent-color-1: #e0f7fa;
      --day-accent-color-2: #ff7043; /* Orange for highlights/errors */
      --day-primary-button-bg: #2196f3; /* Brighter Blue */
      --day-primary-button-hover: #1976d2;
      --day-success-color: #4caf50;
      --day-info-color: #03a9f4;
      --day-border-color: #e0e0e0;
      --day-input-bg: #f9f9f9;
      --day-qr-border: #9e9e9e;
      --day-hr-color: #e0e0e0;
      --day-note-bg: #ffffff; /* Day memo background */
      --day-note-border: #d0d0d0; /* Day memo border */
      --day-note-text: #333333; /* Day memo text */
      --day-pin-input-bg: #f5f5f5;
      --day-pin-input-border: #cccccc;
      --day-note-line-color: #e0e0e0; /* Day memo line color */
      --day-copy-icon-color: #666666; /* Copy icon color */
      --day-watch-button-bg: #03a9f4;
      --day-watch-button-hover: #0288d1;
    }

    body.day-mode {
      --bg-color: var(--day-bg-color);
      --container-bg: var(--day-container-bg);
      --text-color: var(--day-text-color);
      --accent-color-1: var(--day-accent-color-1);
      --accent-color-2: var(--day-accent-color-2);
      --primary-button-bg: var(--day-primary-button-bg);
      --primary-button-hover: var(--day-primary-button-hover);
      --success-color: var(--day-success-color);
      --info-color: var(--day-info-color);
      --border-color: var(--day-border-color);
      --input-bg: var(--day-input-bg);
      --qr-border: var(--day-qr-border);
      --hr-color: var(--day-hr-color);
      --note-bg: var(--day-note-bg);
      --note-border: var(--day-note-border);
      --note-text: var(--day-note-text);
      --pin-input-bg: var(--day-pin-input-bg);
      --pin-input-border: var(--day-pin-input-border);
      --note-line-color: var(--day-note-line-color);
      --copy-icon-color: var(--day-copy-icon-color);
      --watch-button-bg: var(--day-watch-button-bg);
      --watch-button-hover: var(--day-watch-button-hover);
    }

    body {
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      padding: 15px; /* å…¨ä½“çš„ãªãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
      background-color: var(--bg-color);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      color: var(--text-color);
      position: relative;
      transition: background-color 0.5s ease;
      overflow-y: auto;
      line-height: 1.35; /* å…¨ä½“ã®è¡Œé–“ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
    }

    body:not(.day-mode)::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #0c183d, #1a1a2e, #0c183d);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      z-index: -1;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      background-color: var(--container-bg);
      padding: 20px; /* å…¨ä½“çš„ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 12px; /* è§’ä¸¸ã‚’å°‘ã—å°ã•ã */
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
      text-align: center;
      max-width: 500px; /* æœ€å¤§å¹…ã‚’å°‘ã—å°ã•ã */
      width: 100%;
      border: 1px solid var(--border-color); /* æ ç·šã‚’ç´°ã */
      position: relative;
      animation: fadeIn 0.8s ease-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’çŸ­ç¸® */
      transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
      margin: auto;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-15px); } /* å°‘ã—ã ã‘ç§»å‹•è·é›¢ã‚’æ¸›ã‚‰ã™ */
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      color: var(--primary-button-bg);
      margin-bottom: 18px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      font-size: 2em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      text-shadow: 0 0 8px rgba(74, 144, 226, 0.5); /* Glowing effect */
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }
    body.day-mode h1 {
      text-shadow: none;
    }

    h2 {
      color: var(--text-color);
      margin-top: 20px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      margin-bottom: 12px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      font-size: 1.5em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }
    body.day-mode h2 {
      text-shadow: none;
    }

    p {
      color: var(--text-color);
      line-height: 1.4; /* è¡Œé–“ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
      font-size: 0.9em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      margin-bottom: 8px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’è©°ã‚ã‚‹ */
      transition: color 0.5s ease;
    }

    .streamer-info p {
      margin-bottom: 12px;
    }

    .xrpl-address-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 12px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’è©°ã‚ã‚‹ */
    }

    .xrpl-address {
      font-family: 'Share Tech Mono', monospace;
      background-color: var(--input-bg);
      padding: 9px 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 6px; /* è§’ä¸¸ã‚’å°ã•ã */
      font-size: 0.85em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      color: var(--text-color);
      word-break: break-all;
      border: 1px solid var(--border-color);
      width: 100%;
      flex-grow: 1;
      transition: all 0.3s ease;
    }

    .xrpl-address:focus {
      outline: none;
      border-color: var(--primary-button-bg);
      box-shadow: 0 0 6px rgba(74, 144, 226, 0.6);
    }
    body.day-mode .xrpl-address:focus {
      box-shadow: 0 0 6px rgba(33, 150, 243, 0.6);
    }

    .copy-icon-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 3px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ç¯„å›²ã‚’èª¿æ•´ */
      color: var(--copy-icon-color);
      font-size: 1.1em; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
      transition: color 0.3s ease, transform 0.2s ease;
      position: absolute;
      right: 8px; /* ä½ç½®èª¿æ•´ */
      top: 50%;
      transform: translateY(-50%);
    }

    .copy-icon-button:hover {
      color: var(--primary-button-bg);
      transform: translateY(-50%) scale(1.1);
    }
    .copy-icon-button:active {
      transform: translateY(-50%) scale(0.9);
    }

    .address-buttons {
      display: flex;
      gap: 8px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è©°ã‚ã‚‹ */
      justify-content: center;
      margin-bottom: 8px; /* ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’è©°ã‚ã‚‹ */
    }

    .connect-button {
      background-color: var(--primary-button-bg);
      color: white;
      border: none;
      padding: 7px 12px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 6px; /* è§’ä¸¸ã‚’å°ã•ã */
      cursor: pointer;
      font-size: 0.85em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
      flex-grow: 1;
    }

    .connect-button:hover {
      background-color: var(--primary-button-hover);
      transform: translateY(-1px); /* å°‘ã—ã ã‘ç§»å‹• */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .copy-status {
      color: var(--success-color);
      font-weight: bold;
      margin-top: 8px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      font-size: 0.8em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      opacity: 0;
      transition: opacity 0.4s ease-out; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çŸ­ç¸® */
    }
    .copy-status.show {
      opacity: 1;
    }

    .input-group {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      gap: 8px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’æ¸›ã‚‰ã™ */
    }

    .input-group input[type="number"] {
      padding: 9px 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border: 1px solid var(--border-color);
      border-radius: 6px; /* è§’ä¸¸ã‚’å°ã•ã */
      font-size: 1em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      width: 100px; /* å¹…ã‚’èª¿æ•´ */
      text-align: right;
      background-color: var(--input-bg);
      color: var(--text-color);
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.3s ease;
    }

    .input-group input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-button-bg);
      box-shadow: 0 0 6px rgba(74, 144, 226, 0.6);
    }
    body.day-mode .input-group input[type="number"]:focus {
      box-shadow: 0 0 6px rgba(33, 150, 243, 0.6);
    }

    .input-group span {
      font-size: 1em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      font-weight: bold;
      color: var(--primary-button-bg);
      text-shadow: 0 0 4px rgba(74, 144, 226, 0.3);
      transition: color 0.5s ease, text-shadow 0.5s ease;
    }
    body.day-mode .input-group span {
      text-shadow: none;
    }

    .tip-button {
      background-color: var(--accent-color-2);
      color: white;
      border: none;
      padding: 10px 20px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 8px; /* è§’ä¸¸ã‚’å°‘ã—å°ã•ã */
      font-size: 1.1em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
      letter-spacing: 0.2px; /* æ–‡å­—é–“éš”ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
    }

    .tip-button:hover {
      background-color: #d63d58;
      transform: translateY(-2px) scale(1.01); /* å°‘ã—ã ã‘ç§»å‹•ã¨æ‹¡å¤§ */
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
    }
    body.day-mode .tip-button:hover {
      background-color: #f5511e;
    }

    .tip-button:disabled {
      background-color: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .message {
      margin-top: 15px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      padding: 8px 12px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      transition: all 0.4s ease; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’çŸ­ç¸® */
    }

    .message.info {
      background-color: rgba(63, 114, 175, 0.2);
      color: var(--info-color);
      border: 1px solid var(--info-color);
    }
    body.day-mode .message.info {
      background-color: rgba(3, 169, 244, 0.1);
    }

    .message.success {
      background-color: rgba(92, 184, 92, 0.2);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }
    body.day-mode .message.success {
      background-color: rgba(76, 175, 80, 0.1);
    }

    .qr-code-area {
      margin-top: 20px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      padding: 15px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
      background-color: var(--accent-color-1);
      border-radius: 10px; /* è§’ä¸¸ã‚’å°ã•ã */
      border: 2px dashed var(--qr-border);
      display: none;
      opacity: 0;
      transform: scale(0.95); /* å°‘ã—ã ã‘ç¸®å° */
      transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.5s ease, border-color 0.5s ease; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’çŸ­ç¸® */
    }

    .qr-code-area.show {
      opacity: 1;
      transform: scale(1);
    }

    .qr-image {
      width: 160px; /* QRã‚³ãƒ¼ãƒ‰ã‚’ã•ã‚‰ã«å°ã•ã */
      height: 160px;
      margin: 15px auto;
      display: block;
      border: 5px solid white; /* æ ç·šã‚’ç´°ã */
      border-radius: 4px; /* è§’ä¸¸ã‚’å°ã•ã */
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
      transition: border-color 0.5s ease, box-shadow 0.5s ease;
    }
    
    .qr-code-area p {
      font-size: 0.8em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      line-height: 1.25;
      margin-bottom: 6px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’è©°ã‚ã‚‹ */
    }

    .qr-code-area p:last-of-type {
        margin-top: 12px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’è©°ã‚ã‚‹ */
    }

    .qr-buttons-group {
        display: flex;
        flex-wrap: wrap; /* ãƒœã‚¿ãƒ³ã‚’æŠ˜ã‚Šè¿”ã™ */
        justify-content: center;
        gap: 8px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        margin-top: 10px;
    }

    .action-button { /* General style for action buttons in QR area */
      color: white;
      border: none;
      padding: 9px 18px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 6px; /* è§’ä¸¸ã‚’å°ã•ã */
      font-size: 0.9em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      cursor: pointer;
      font-family: 'Orbitron', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      flex-grow: 1; /* ãƒœã‚¿ãƒ³ã‚’æ¨ªã«åºƒã’ã‚‹ */
      min-width: 120px; /* æœ€å°å¹…ã‚’è¨­å®š */
    }

    .open-xaman-button {
      background-color: var(--success-color);
    }
    .open-xaman-button:hover {
      background-color: #4CAF50;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    body.day-mode .open-xaman-button {
      background-color: var(--day-success-color);
    }
    body.day-mode .open-xaman-button:hover {
      background-color: #388e3c;
    }

    .send-to-watch-button {
        background-color: var(--watch-button-bg); /* æ–°ã—ã„ãƒœã‚¿ãƒ³ã®è‰² */
    }
    .send-to-watch-button:hover {
        background-color: var(--watch-button-hover);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    body.day-mode .send-to-watch-button {
        background-color: var(--day-watch-button-bg);
    }
    body.day-mode .send-to-watch-button:hover {
        background-color: var(--day-watch-button-hover);
    }

    .watch-transfer-section {
        background-color: var(--accent-color-1); /* QRã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã¨åŒã˜èƒŒæ™¯è‰² */
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
        display: none; /* Initially hidden */
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.5s ease;
        border: 1px dashed var(--qr-border);
    }
    .watch-transfer-section.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
    .watch-transfer-section p {
        margin-bottom: 10px;
        font-size: 0.85em;
        text-align: left;
    }
    .watch-transfer-section ul {
        list-style: none; /* ãƒ‰ãƒƒãƒˆã‚’æ¶ˆã™ */
        padding-left: 0;
        margin-bottom: 10px;
        font-size: 0.8em;
        text-align: left;
        line-height: 1.4;
    }
    .watch-transfer-section li {
        margin-bottom: 5px;
    }
    .watch-transfer-section strong {
        color: var(--primary-button-bg);
    }


    hr {
      border: none;
      border-top: 1px dashed var(--hr-color);
      margin: 25px 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      transition: border-color 0.5s ease;
    }

    .container button:not(.tip-button):hover,
    .container input:not([type="number"]):hover {
      box-shadow: 0 0 12px rgba(74, 144, 226, 0.8); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
    }
    body.day-mode .container button:not(.tip-button):hover,
    body.day-mode .container input:not([type="number"]):hover {
      box-shadow: 0 0 12px rgba(33, 150, 243, 0.8);
    }

    /* Theme Toggle Switch */
    .theme-switch-wrapper {
      margin-bottom: 12px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      gap: 6px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’æ¸›ã‚‰ã™ */
    }
    .theme-switch-wrapper span {
      font-size: 0.8em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
    }
    .theme-switch {
      height: 22px; /* é«˜ã•ã‚’å°ã•ã */
      width: 40px; /* å¹…ã‚’å°ã•ã */
    }
    .slider:before {
      bottom: 2px; /* ä½ç½®èª¿æ•´ */
      height: 18px; /* ã‚µã‚¤ã‚ºã‚’å°ã•ã */
      left: 2px; /* ä½ç½®èª¿æ•´ */
      width: 18px; /* ã‚µã‚¤ã‚ºã‚’å°ã•ã */
    }
    input:checked + .slider:before {
      transform: translateX(18px); /* ã‚¹ãƒ©ã‚¤ãƒ‰è·é›¢èª¿æ•´ */
    }

    /* PIN and Memo Section */
    .memo-section {
      margin-top: 20px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      padding: 15px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
      border-radius: 10px; /* è§’ä¸¸ã‚’å°ã•ã */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’èª¿æ•´ */
    }
    .memo-section.show {
      transform: translateY(0);
    }

    .memo-section h3 {
      font-size: 1.2em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      margin-bottom: 12px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
    }

    .pin-input-group {
      margin-bottom: 12px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
    }
    .pin-input-group input {
      width: 100px; /* å¹…ã‚’ã•ã‚‰ã«å°ã•ã */
      padding: 7px 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      font-size: 0.9em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      border-radius: 6px;
    }

    .pin-button {
      padding: 7px 18px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™ */
      border-radius: 6px;
      font-size: 0.85em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      margin-top: 8px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
    }
    .pin-status {
      font-size: 0.75em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      margin-top: 6px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
    }

    /* Memo input styling */
    .memo-input-container {
      margin-top: 15px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      border-radius: 8px; /* è§’ä¸¸ã‚’å°ã•ã */
      padding: 8px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
    }

    .memo-input {
      min-height: 100px; /* min-heightã‚’ã•ã‚‰ã«èª¿æ•´ */
      padding: 4px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«èª¿æ•´ */
      font-size: 0.9em; /* æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ã */
      line-height: 1.6em; /* è¡Œé–“ã‚’ã•ã‚‰ã«è©°ã‚ã‚‹ */
      background-image:
          repeating-linear-gradient(
              to bottom,
              transparent,
              transparent 1.5em, /* Line height - 0.1em margin */
              var(--note-line-color) 1.6em /* Line color */
          );
      background-size: 100% 1.6em; /* background-sizeã‚‚è¡Œé–“ã«åˆã‚ã›ã‚‹ */
    }
    body.day-mode .memo-input {
      background-image:
          repeating-linear-gradient(
              to bottom,
              transparent,
              transparent 1.5em,
              var(--day-note-line-color) 1.6em
          );
    }

    /* Animations for emojis */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); } /* å°‘ã—æ§ãˆã‚ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      100% { transform: scale(1); }
    }
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="night-mode">
  <div class="container">
    <div class="theme-switch-wrapper">
      <span>â˜€ï¸ Day Mode</span>
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" onchange="toggleTheme()" checked />
        <div class="slider round"></div>
      </label>
      <span>ğŸŒŒ Night Mode</span>
    </div>

    <h1><span style="font-size: 1.4em; animation: pulse 2s infinite;">ğŸ’¸</span> XRPã‚’å—ã‘å–ã‚‹</h1>

    <div class="streamer-info">
      <p>ã‚ãªãŸã®XRPLãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„ï¼š</p>
      <div class="xrpl-address-wrapper">
        <input type="text" id="streamerAddressInput" class="xrpl-address" placeholder="ä¾‹: r...abc123" />
        <button onclick="copyAddress()" class="copy-icon-button" aria-label="ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
      </div>
      <div class="address-buttons">
        <button onclick="connectWallet()" class="connect-button">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«æ¥ç¶š <span style="margin-left: 5px;">ğŸš€</span></button>
      </div>
      <p id="copyStatus" class="copy-status">âœ¨ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</p>
    </div>

    <hr>

    <div class="viewer-section">
      <h2><span style="font-size: 1.1em; animation: rotate 3s infinite linear;">ğŸ’°</span> XRPã‚’æŠ•ã’éŠ­ã—ã¦ã‚‚ã‚‰ã†</h2>
      <p>ï¼ˆã“ã®ãƒ‡ãƒ¢ã§ã¯0.1XRPå›ºå®šã§ã™ï¼‰</p>
      <div class="input-group">
        <input type="number" id="tipAmount" value="0.1" disabled> <span>XRP</span>
      </div>
      <button onclick="sendTip()" id="tipButton" class="tip-button">XRPã‚’æŠ•ã’éŠ­ã—ã¦ã‚‚ã‚‰ã† <span style="margin-left: 8px;">âœ¨</span></button>
      <p id="message" class="message"></p>
      <div id="qrCodeArea" class="qr-code-area">
        <p>ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹å ´åˆ: <br>Xamanã‚¢ãƒ—ãƒªã§QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        <img id="qrImage" class="qr-image" alt="QR Code">
        
        <p>**åŒã˜æºå¸¯ã§é€é‡‘ã™ã‚‹å ´åˆ:**</p>
        <div class="qr-buttons-group">
            <button id="openXamanButton" class="action-button open-xaman-button">Xamanã‚¢ãƒ—ãƒªã§é–‹ã <span style="margin-left: 5px;">ğŸ“±</span></button>
            <button id="sendToWatchButton" class="action-button send-to-watch-button" onclick="sendQrToWatch()">Apple Watchã«é€ã‚‹ âŒšï¸</button>
        </div>

        <div id="watchTransferSection" class="watch-transfer-section">
            <p><strong>Apple Watchã«QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•:</strong></p>
            <ul>
                <li><strong>AirDrop (æ¨å¥¨):</strong> ã€ŒApple Watchã«é€ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—å¾Œã€AirDropã®å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ãŠä½¿ã„ã®Apple Watchã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</li>
                <li><strong>å†™çœŸã‚¢ãƒ—ãƒªçµŒç”±:</strong> AirDropãŒã†ã¾ãã„ã‹ãªã„å ´åˆã€QRã‚³ãƒ¼ãƒ‰ç”»åƒã¯ã€Œå†™çœŸã€ã‚¢ãƒ—ãƒªã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚Apple Watchã§å†™çœŸã‚¢ãƒ—ãƒªã‚’é–‹ãã€ä¿å­˜ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚</li>
            </ul>
        </div>
      </div>
    </div>

    <hr>

    <div id="memoSection" class="memo-section">
        <h3><span style="font-size: 1.1em;">ğŸ“</span> ãƒ¡ãƒ¢æ©Ÿèƒ½</h3>
        
        <div id="memoInputControls" class="memo-input-controls">
          <p id="pinInstruction"></p>
          <div class="pin-input-group">
              <input type="password" id="pinInput" placeholder="PINã‚³ãƒ¼ãƒ‰ (4æ¡)" maxlength="4" onkeyup="checkPinInput()">
          </div>
          <p id="pinStatus" class="pin-status"></p>
          <button onclick="verifyPin()" id="verifyPinButton" class="pin-button" disabled>PINã‚’èªè¨¼</button>
        </div>

        <div id="memoInputContainer" class="memo-input-container">
            <textarea id="privateMemo" class="memo-input" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
        </div>
    </div>

  </div>

  <script>
    // ... æ—¢å­˜ã®JavaScriptã‚³ãƒ¼ãƒ‰ ...

    let currentXummPayloadUrl = ''; // XUMMãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®QRã‚³ãƒ¼ãƒ‰URLã‚’æ ¼ç´

    async function sendTip() {
        const tipButton = document.getElementById('tipButton');
        const messageElement = document.getElementById('message');
        const qrCodeArea = document.getElementById('qrCodeArea');
        const qrImage = document.getElementById('qrImage');
        const watchTransferSection = document.getElementById('watchTransferSection');
        const address = document.getElementById('streamerAddressInput').value.trim();
        const tipAmount = document.getElementById('tipAmount').value; // é‡‘é¡ã‚‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ¸¡ã™

        if (!isValidXrplAddress(address)) {
            if (address === '') {
                connectWallet();
                return;
            }
            alert('æ­£ã—ã„XRPLã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        tipButton.disabled = true;
        messageElement.textContent = 'ğŸŒŒ XUMMæ”¯æ‰•ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç”Ÿæˆä¸­ã§ã™...';
        messageElement.className = 'message info';
        qrCodeArea.classList.remove('show');
        watchTransferSection.classList.remove('show');

        try {
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦XUMMãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
            const response = await fetch('/api/create-xumm-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    destination: address,
                    amount: tipAmount,
                    // memo: document.getElementById('privateMemo').value, // ãƒ¡ãƒ¢ã‚‚é€ã‚ŠãŸã„å ´åˆã¯è¿½åŠ 
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'XUMMæ”¯æ‰•ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            const data = await response.json();
            currentXummPayloadUrl = data.qrCodeUrl; // XUMMã‹ã‚‰è¿”ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰URL
            currentXrpUri = data.xummDeepLink; // XUMMãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã‚‚å–å¾— (Xamanã‚¢ãƒ—ãƒªã§é–‹ãã«åˆ©ç”¨)

            if (currentXummPayloadUrl) {
                qrImage.src = currentXummPayloadUrl;

                qrImage.onload = () => {
                    qrCodeArea.style.display = 'block';
                    setTimeout(() => {
                        qrCodeArea.classList.add('show');
                    }, 50);
                    messageElement.textContent = 'âœ… æŠ•ã’éŠ­æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼Xamanã‚¢ãƒ—ãƒªã§QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‹ã€ç›´æ¥é–‹ã„ã¦ãã ã•ã„ã€‚';
                    messageElement.className = 'message success';
                    tipButton.disabled = false;
                };
                qrImage.onerror = () => {
                    messageElement.textContent = 'âŒ QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    messageElement.className = 'message error';
                    tipButton.disabled = false;
                };
            } else {
                throw new Error('QRã‚³ãƒ¼ãƒ‰URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            }

        } catch (error) {
            console.error('æ”¯æ‰•ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            messageElement.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            messageElement.className = 'message error';
            tipButton.disabled = false;
        }
    }

    // openXamanDeepLinké–¢æ•°ã‚‚ currentXrpUri ã‚’ä½¿ã†ã‚ˆã†ã«èª¿æ•´
    function openXamanDeepLink(uri) {
        // ... (ã“ã®é–¢æ•°ã¯å¤§ããå¤‰æ›´ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€currentXrpUri ãŒ xumm:// ã®å½¢å¼ã«ãªã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¾ã™) ...
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS || isAndroid) {
            // XUMM APIã‹ã‚‰è¿”ã•ã‚Œã‚‹URIã¯æ—¢ã« xumm:// ã¾ãŸã¯ https://xumm.app/ ã®å½¢å¼ãªã®ã§ã€xrp.to ã®å¤‰æ›ã¯ä¸è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™
            // å¿…è¦ã«å¿œã˜ã¦ `uri.replace('https://xumm.app/', 'xumm://')` ã®ã‚ˆã†ãªå¤‰æ›ã‚’å…¥ã‚Œã‚‹
            window.location.href = uri; 

            const timeout = setTimeout(() => {
                if (isIOS) {
                    window.location.href = 'https://apps.apple.com/jp/app/xaman-wallet/id1492302343';
                } else if (isAndroid) {
                    window.location.href = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';
                }
            }, 1000);

            const handleVisibilityChangeForApp = () => {
                if (!document.hidden) {
                    clearTimeout(timeout);
                    document.removeEventListener('visibilitychange', handleVisibilityChangeForApp);
                }
            };
            document.addEventListener('visibilitychange', handleVisibilityChangeForApp);

        } else {
            window.open(uri, '_blank');
            alert('PCã§ã¯Xamanã‚¢ãƒ—ãƒªã¯é€šå¸¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Xummã®ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã®ã§ã€ãã¡ã‚‰ã§æ‰‹ç¶šãã‚’é€²ã‚ã¦ãã ã•ã„ã€‚');
        }
    }
    let currentXrpUri = ''; // Global variable to store the generated XRP URI
    let currentQrImageUrl = ''; // Global variable to store the generated QR code image URL
    const LOCAL_STORAGE_PIN_KEY = 'memoPinCode'; // PINã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ¼
    const LOCAL_STORAGE_MEMO_UNLOCKED_KEY = 'memoUnlocked'; // ãƒ¡ãƒ¢ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸçŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ¼
    const LOCAL_STORAGE_MEMO_CONTENT_KEY = 'privateMemoContent'; // ãƒ¡ãƒ¢ã®å†…å®¹ã‚’ä¿å­˜ã™ã‚‹ã‚­ãƒ¼

    let storedPin = null; // ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹PIN
    let inactivityTimer; // ã‚¹ãƒªãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ã‚’æ¤œå‡ºã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼
    const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5åˆ† (ãƒŸãƒªç§’)

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('streamerAddressInput').value = '';
      // Set initial theme based on local storage or default to night mode
      const savedTheme = localStorage.getItem('theme') || 'night-mode';
      document.body.className = savedTheme;
      document.getElementById('checkbox').checked = (savedTheme === 'night-mode');

      // ãƒ¡ãƒ¢æ©Ÿèƒ½ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      initializeMemoSection();
      
      // Load saved memo
      const savedMemo = localStorage.getItem(LOCAL_STORAGE_MEMO_CONTENT_KEY);
      if (savedMemo) {
          document.getElementById('privateMemo').value = savedMemo;
      }
      // Save memo on input change
      document.getElementById('privateMemo').addEventListener('input', (event) => {
          localStorage.setItem(LOCAL_STORAGE_MEMO_CONTENT_KEY, event.target.value);
      });

      // Event listener for the "Open in Xaman" button
      document.getElementById('openXamanButton').addEventListener('click', () => {
          if (currentXrpUri) {
              // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§ã®ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯è©¦è¡Œ
              openXamanDeepLink(currentXrpUri);
          } else {
              alert('ã¾ãšæŠ•ã’éŠ­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é€é‡‘ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
          }
      });

      // ã‚¹ãƒªãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰æ¤œå‡ºã®ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      document.addEventListener('visibilitychange', handleVisibilityChange);
      document.addEventListener('mousemove', resetInactivityTimer);
      document.addEventListener('keydown', resetInactivityTimer);
      document.addEventListener('click', resetInactivityTimer);
      document.addEventListener('scroll', resetInactivityTimer);
      document.addEventListener('touchstart', resetInactivityTimer);
      resetInactivityTimer(); // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    });

    // ã‚¹ãƒªãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ï¼ˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰æ¤œå‡ºã®ãŸã‚ã®å‡¦ç†
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(lockMemoSection, INACTIVITY_TIMEOUT);
    }

    function handleVisibilityChange() {
        if (document.hidden) {
            // ã‚¿ãƒ–ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸå ´åˆã€ã™ãã«ãƒ­ãƒƒã‚¯
            lockMemoSection();
        } else {
            // ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æˆ»ã£ãŸå ´åˆã€ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            resetInactivityTimer();
        }
    }

    function lockMemoSection() {
        // ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ãƒ­ãƒƒã‚¯å‡¦ç†ã‚’è¡Œã†
        if (localStorage.getItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY) === 'true') {
            localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'false'); // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«è¨­å®š
            document.getElementById('memoInputContainer').classList.remove('show'); // ãƒ¡ãƒ¢å…¥åŠ›æ¬„ã‚’éš ã™
            document.getElementById('memoInputControls').classList.remove('hidden'); // PINå…¥åŠ›æ¬„ã‚’è¡¨ç¤º
            document.getElementById('pinInput').value = ''; // PINå…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('pinInput').focus(); // PINå…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            document.getElementById('pinInstruction').textContent = 'ãƒ¡ãƒ¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯PINã‚³ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            document.getElementById('pinStatus').textContent = '';
            document.getElementById('verifyPinButton').disabled = true;
            // ã‚¢ãƒ©ãƒ¼ãƒˆã¯åˆå›ã®ãƒ­ãƒƒã‚¯æ™‚ã®ã¿è¡¨ç¤ºã—ã€ä»¥é™ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿
            console.log('Memo section locked due to inactivity or visibility change.');
        }
    }


    function toggleTheme() {
      const body = document.body;
      if (body.classList.contains('day-mode')) {
        body.classList.remove('day-mode');
        body.classList.add('night-mode');
        localStorage.setItem('theme', 'night-mode');
      } else {
        body.classList.remove('night-mode');
        body.classList.add('day-mode');
        localStorage.setItem('theme', 'day-mode');
      }
    }

    async function copyAddress() {
      try {
        const address = document.getElementById('streamerAddressInput').value;
        if (!address) {
          alert('ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
        await navigator.clipboard.writeText(address);
        const copyStatus = document.getElementById('copyStatus');
        copyStatus.classList.add('show');
        setTimeout(() => {
          copyStatus.classList.remove('show');
        }, 1500); // è¡¨ç¤ºæ™‚é–“ã‚’å°‘ã—çŸ­ç¸®
      } catch (err) {
        console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    function isValidXrplAddress(address) {
      return /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/.test(address);
    }

    async function sendTip() {
      const tipButton = document.getElementById('tipButton');
      const messageElement = document.getElementById('message');
      const qrCodeArea = document.getElementById('qrCodeArea');
      const qrImage = document.getElementById('qrImage');
      const watchTransferSection = document.getElementById('watchTransferSection');
      const address = document.getElementById('streamerAddressInput').value.trim();

      if (!isValidXrplAddress(address)) {
        // ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãªã„å ´åˆã¯è‡ªå‹•çš„ã«Xamanæ¥ç¶šã¸èª˜å°
        if (address === '') {
            connectWallet(); // ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãªã„å ´åˆã¯Xamanã‚¢ãƒ—ãƒªã«æ¥ç¶šã‚’è©¦ã¿ã‚‹
            return;
        }
        alert('æ­£ã—ã„XRPLã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      currentXrpUri = `https://xrp.to/?to=${encodeURIComponent(address)}&amount=0.1`; // Store the URI
      currentQrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(currentXrpUri)}`; // QRç”»åƒã®URLã‚‚ä¿å­˜

      tipButton.disabled = true;
      messageElement.textContent = 'ğŸŒŒ QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­ã§ã™...';
      messageElement.className = 'message info';
      qrCodeArea.classList.remove('show');
      watchTransferSection.classList.remove('show'); // Apple Watchã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚éš ã™
      
      qrImage.src = currentQrImageUrl;
      
      // QRã‚³ãƒ¼ãƒ‰ã®ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¦ã‹ã‚‰è¡¨ç¤ºã™ã‚‹
      qrImage.onload = () => {
        qrCodeArea.style.display = 'block';
        setTimeout(() => {
            qrCodeArea.classList.add('show');
        }, 50); 
        messageElement.textContent = 'âœ… æŠ•ã’éŠ­æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‹ã€Xamanã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãã ã•ã„ã€‚';
        messageElement.className = 'message success';
        tipButton.disabled = false;
      };
      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      qrImage.onerror = () => {
        messageElement.textContent = 'âŒ QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        messageElement.className = 'message error'; // ã‚¨ãƒ©ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒã‚ã‚Œã°
        tipButton.disabled = false;
      };
    }

    // Xamanã‚¢ãƒ—ãƒªã¸ã®ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã‚’è©¦ã¿ã‚‹é–¢æ•°
    function openXamanDeepLink(uri) {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS || isAndroid) {
            // ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã®å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ¼ãƒ ã§Xamanã‚¢ãƒ—ãƒªã‚’ç›´æ¥é–‹ãã“ã¨ã‚’è©¦ã¿ã‚‹
            const customSchemeUri = uri.replace('https://xrp.to/', 'xaman://xrp.to/'); // xrp.toã®URIã‚’Xamanã‚¹ã‚­ãƒ¼ãƒ ã«å¤‰æ›

            window.location.href = customSchemeUri;

            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ã€ä¸€å®šæ™‚é–“å¾Œã«App Store/Google Play Storeã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            // Xamanã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã€ã“ã®ã‚¿ã‚¤ãƒãƒ¼ãŒç™ºç«ã™ã‚‹
            const timeout = setTimeout(() => {
                if (isIOS) {
                    window.location.href = 'https://apps.apple.com/jp/app/xaman-wallet/id1492302343';
                } else if (isAndroid) {
                    window.location.href = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';
                }
            }, 1000); // 1ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è©¦ã¿ã‚‹ (çŸ­ç¸®)

            // ã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«é–‹ã„ãŸå ´åˆã€ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            // visibilitychangeã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¢ãƒ—ãƒªèµ·å‹•ã¯ã€ã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•
            const handleVisibilityChangeForApp = () => {
                if (!document.hidden) { // ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã‹ã‚‰æˆ»ã£ãŸå ´åˆ
                    clearTimeout(timeout);
                    document.removeEventListener('visibilitychange', handleVisibilityChangeForApp);
                }
            };
            document.addEventListener('visibilitychange', handleVisibilityChangeForApp);

        } else {
            // PCã®å ´åˆã€xrp.toã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’é–‹ã
            window.open(uri, '_blank');
            alert('PCã§ã¯Xamanã‚¢ãƒ—ãƒªã¯é€šå¸¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚XRP.toã®ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã®ã§ã€ãã¡ã‚‰ã§æ‰‹ç¶šãã‚’é€²ã‚ã¦ãã ã•ã„ã€‚');
        }
    }


    // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šæ©Ÿèƒ½ï¼ˆXamanå¯¾å¿œï¼‰
    async function connectWallet() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS || isAndroid) {
            // ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã®å ´åˆã®å‡¦ç†
            const xamanDeepLink = 'xaman://'; // Xamanã‚¢ãƒ—ãƒªã‚’é–‹ããƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯
            const appStoreLink = 'https://apps.apple.com/jp/app/xaman-wallet/id1492302343';
            const playStoreLink = 'https://play.google.com/store/apps/details?id=com.xrpllabs.xumm';

            window.location.href = xamanDeepLink;

            const timeout = setTimeout(() => {
                if (isIOS) {
                    window.location.href = appStoreLink;
                } else if (isAndroid) {
                    window.location.href = playStoreLink;
                }
            }, 1500);

            const handleVisibilityChangeForApp = () => {
                if (!document.hidden) {
                    clearTimeout(timeout);
                    document.removeEventListener('visibilitychange', handleVisibilityChangeForApp);
                }
            };
            document.addEventListener('visibilitychange', handleVisibilityChangeForApp);

            alert("Xamanã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã—ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã—ãªã„å ´åˆã¯ã€æ•°ç§’å¾Œã«ã‚¹ãƒˆã‚¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚");

        } else {
            if (window.xrpl) { // XRPL.jsã®ã‚ˆã†ãªãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã®æ¤œå‡º
                try {
                    const result = await window.xrpl.request({
                        command: "account_info",
                        account: null
                    });
                    const address = result.account_data?.Account;
                    if (address) {
                        document.getElementById("streamerAddressInput").value = address;
                        alert("ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«æ¥ç¶šã—ã¾ã—ãŸï¼");
                    } else {
                        alert("ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                } catch (error) {
                    console.error("ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼:", error);
                    alert("ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚Xamanä»¥å¤–ã®XRPLãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            } else {
                alert("Xamanã¯ä¸»ã«ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§ã™ã€‚PCãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«æ¥ç¶šã™ã‚‹æ‹¡å¼µæ©Ÿèƒ½ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€ã€Œã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«æ¥ç¶šã€ã¾ãŸã¯ã€ŒXamanã‚¢ãƒ—ãƒªã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’ã”åˆ©ç”¨ã„ãŸã ãã‹ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            }
        }
    }

    // Apple Watchã«QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’å…±æœ‰ã™ã‚‹æ©Ÿèƒ½
    async function sendQrToWatch() {
        if (!currentQrImageUrl) {
            alert('å…ˆã«ã€ŒXRPã‚’æŠ•ã’éŠ­ã—ã¦ã‚‚ã‚‰ã†ã€ãƒœã‚¿ãƒ³ã§QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const watchTransferSection = document.getElementById('watchTransferSection');
        watchTransferSection.classList.add('show'); // èª¬æ˜æ–‡ã‚’è¡¨ç¤º

        try {
            // QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’Blobã¨ã—ã¦ãƒ•ã‚§ãƒƒãƒ
            const response = await fetch(currentQrImageUrl);
            const blob = await response.blob();
            const file = new File([blob], 'xrp_qr_code.png', { type: 'image/png' });

            // Web Share APIã‚’ä½¿ç”¨ã—ã¦å…±æœ‰ï¼ˆAirDropãªã©ã‚’åˆ©ç”¨ï¼‰
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'XRP QRã‚³ãƒ¼ãƒ‰',
                    text: 'XRPæŠ•ã’éŠ­ç”¨ã®QRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚Apple Watchã«é€ä¿¡ã—ã¦ãã ã•ã„ã€‚'
                });
                console.log('QRã‚³ãƒ¼ãƒ‰ãŒå…±æœ‰ã•ã‚Œã¾ã—ãŸã€‚');
            } else {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã€QRã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å…±æœ‰ã§ãã¾ã›ã‚“ã€‚QRã‚³ãƒ¼ãƒ‰ã‚’é•·æŠ¼ã—ã—ã¦ç”»åƒã‚’ä¿å­˜ã—ã€å†™çœŸã‚¢ãƒ—ãƒªã‹ã‚‰Apple Watchã«è»¢é€ã—ã¦ãã ã•ã„ã€‚');
                console.warn('Web Share API (Files) is not supported or cannot share these files.');
                // å…±æœ‰APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ã€ç”»åƒä¿å­˜ã‚’ä¿ƒã™
                // ã¾ãŸã¯ã€ã“ã“ã§ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚æ¤œè¨ã§ãã¾ã™ã€‚
            }
        } catch (error) {
            console.error('QRã‚³ãƒ¼ãƒ‰ã®å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            alert('QRã‚³ãƒ¼ãƒ‰ã®å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã€å†™çœŸã‚¢ãƒ—ãƒªçµŒç”±ã§Apple Watchã«è»¢é€ã—ã¦ãã ã•ã„ã€‚');
        }
    }


    // --- PIN and Memo Functions ---

    function initializeMemoSection() {
        const memoUnlocked = localStorage.getItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY) === 'true';
        const pinInput = document.getElementById('pinInput');
        const pinInstruction = document.getElementById('pinInstruction');
        const memoInputContainer = document.getElementById('memoInputContainer');
        const memoInputControls = document.getElementById('memoInputControls');

        storedPin = localStorage.getItem(LOCAL_STORAGE_PIN_KEY);

        document.getElementById('memoSection').classList.add('show');

        if (memoUnlocked && storedPin) {
            pinInstruction.textContent = 'ãƒ¡ãƒ¢ã«ã‚¢ã‚¯ã‚»ã‚¹æ¸ˆã¿ã§ã™ã€‚';
            memoInputControls.classList.add('hidden');
            memoInputContainer.classList.add('show');
        } else if (storedPin) {
            pinInstruction.textContent = 'ãƒ¡ãƒ¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯PINã‚³ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            memoInputControls.classList.remove('hidden');
            memoInputContainer.classList.remove('show');
        } else {
            pinInstruction.textContent = 'ãƒ¡ãƒ¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®PINã‚³ãƒ¼ãƒ‰ã‚’4æ¡ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚';
            memoInputControls.classList.remove('hidden');
            memoInputContainer.classList.remove('show');
        }
        pinInput.value = '';
        checkPinInput();
    }

    function checkPinInput() {
        const pinInput = document.getElementById('pinInput');
        const verifyButton = document.getElementById('verifyPinButton');
        const pinStatus = document.getElementById('pinStatus');

        if (pinInput.value.length === 4) {
            verifyButton.disabled = false;
        } else {
            verifyButton.disabled = true;
        }

        if (pinInput.value.length > 0 && pinInput.value.length < 4) {
            pinStatus.textContent = 'PINã‚³ãƒ¼ãƒ‰ã¯4æ¡ã§ã™ã€‚';
            pinStatus.style.color = 'var(--text-color)';
        } else {
            pinStatus.textContent = '';
        }
    }

    function verifyPin() {
        const enteredPin = document.getElementById('pinInput').value;
        const pinStatus = document.getElementById('pinStatus');
        const memoInputContainer = document.getElementById('memoInputContainer');
        const pinInput = document.getElementById('pinInput');
        const verifyPinButton = document.getElementById('verifyPinButton');
        const memoInputControls = document.getElementById('memoInputControls');


        if (!storedPin) {
            localStorage.setItem(LOCAL_STORAGE_PIN_KEY, enteredPin);
            storedPin = enteredPin;
            localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'true');
            pinStatus.textContent = 'æ–°ã—ã„PINã‚³ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼';
            pinStatus.style.color = 'var(--success-color)';
            
            memoInputControls.classList.add('hidden');
            memoInputContainer.classList.add('show');
            pinInput.value = '';
            document.getElementById('privateMemo').focus();
            resetInactivityTimer();
        } else {
            if (enteredPin === storedPin) {
                localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'true');
                pinStatus.textContent = 'PINã‚³ãƒ¼ãƒ‰ãŒèªè¨¼ã•ã‚Œã¾ã—ãŸï¼';
                pinStatus.style.color = 'var(--success-color)';
                
                memoInputControls.classList.add('hidden');
                memoInputContainer.classList.add('show');
                pinInput.value = '';
                document.getElementById('privateMemo').focus();
                resetInactivityTimer();
            } else {
                localStorage.setItem(LOCAL_STORAGE_MEMO_UNLOCKED_KEY, 'false');
                pinStatus.textContent = 'PINã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                pinStatus.style.color = 'var(--accent-color-2)';
                memoInputContainer.classList.remove('show');
                pinInput.value = '';
                verifyPinButton.disabled = true;
            }
        }
    }
  </script>
</body>
</html>
